<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>not3</title>

    <style>
        html, body, canvas {
				padding: 0;
				margin: 0;
				width: 100%;
				height: 100%;
                overflow: hidden;
			}
		</style>
</head>

<body>

    <canvas></canvas>
    <div id="info"></div>

    <script id="fs" type="x-shader/fragment">
        #version 300 es

        out vec4 outColor;

        const float tau = 6.28318530718;

        uniform float time;
        uniform float rpm;
        uniform vec2 resolution;

        struct astruct{ float val; };
        struct bstruct{ astruct sub; float val; };
        struct cstruct{ bstruct sub; float val; };
        struct dstruct{ cstruct sub; float val; };

        uniform dstruct hand1;
        uniform dstruct hand2;

        uniform sampler2D u_image0;
        uniform sampler2D u_image1;

        const int TEST_DATA_SIZE = 64;
        uniform dstruct testdata[TEST_DATA_SIZE];

        vec4 getColor(dstruct d){ return vec4( d.val, d.sub.val, d.sub.sub.val, d.sub.sub.sub.val); }

        bool hand(float a){
            return sin(a + rpm) > 0.999;
        }

        void main( ) {
            vec2 pos = - 1.0 + 2.0 * gl_FragCoord.xy / resolution.xy;
            float a = atan(pos.y, pos.x);

            if(gl_FragCoord.x + gl_FragCoord.y < 128.0){
                outColor = texture( u_image0, vec2( mod(gl_FragCoord.x, 32.0)/32.0, mod(gl_FragCoord.y, 32.0)/32.0 ) );
            }else if(gl_FragCoord.x + gl_FragCoord.y < 150.0){
                for(int i=0; i<TEST_DATA_SIZE; i++){
                    if(i > int(gl_FragCoord.x)){
                        outColor = getColor( testdata[i] );
                        break;
                    }
                }
            } else if(hand(a + rpm)){
                outColor = getColor( hand1 );
            } else if(hand(a + 60.0*rpm)){
                outColor = getColor( hand2 );
            } else {
                float ma = a - mod(a, tau/12.0);
                outColor = vec4( hand(a + rpm) , hand(a + 60.0*rpm) , 0.5 + 0.5*sin(ma) , 1);
            }
        }
 
		</script>

    <script src="fraggle.js"></script>
    <script>
        function generateDstruct(r, g, b, a) {
            return {
                val: r,
                sub: {
                    val: g,
                    sub: {
                        val: b,
                        sub: {
                            val: a
                        }
                    }
                }
            }
        }

        function gen(len, fun) {
            let result = [];
            for (let i = 0; i < len; i++) result.push(fun(i));
            return result;
        }

        function randomByte() {
            return Math.floor(Math.random() * 255);
        }

        not3({
            uniforms: {
                rpm: 0,
                hand1: generateDstruct(1, 0, 1, 1),
                hand2: generateDstruct(0, 1, 0, 1),
                testdata: gen(64, i => generateDstruct(Math.random(), Math.random(), Math.random(), 1))
            },
            textures: [{
                name: 'u_image0',
                resolution: [32, 32],
                data: new Uint8Array(gen(4 * 32 * 32, i => i % 4 === 3 ? 255 : randomByte()))
            }, {
                name: 'u_image1',
                resolution: [32, 32],
                data: new Uint8Array(gen(4 * 32 * 32, i => i % 4 === 3 ? 255 : randomByte()))
            }],
            update: function (u, t) {
                u.rpm = 2 * Math.PI * (u.time % 60) / 60;
            }
        });
    </script>
</body>

</html>